# 云开发

## 云开发初始化

### 步骤1

在project.config.json文件里面添加：

```
"cloudfunctionRoot": "cloud/",
```

### 步骤2

文件总览

```
{
    "description": "项目配置文件",
    "cloudfunctionRoot": "cloud/",
    "packOptions": {
        "ignore": [
            {
                "type": "file",
                "value": ".eslintrc.js"
            }
        ]
    },
    "setting": {
        "bundle": false,
        "userConfirmedBundleSwitch": false,
        "urlCheck": true,
        "scopeDataCheck": false,
        "coverView": true,
        "es6": true,
        "postcss": true,
        "compileHotReLoad": true,
        "lazyloadPlaceholderEnable": false,
        "preloadBackgroundData": false,
        "minified": true,
        "autoAudits": false,
        "newFeature": false,
        "uglifyFileName": false,
        "uploadWithSourceMap": true,
        "useIsolateContext": true,
        "nodeModules": false,
        "enhance": true,
        "useMultiFrameRuntime": true,
        "useApiHook": true,
        "useApiHostProcess": true,
        "showShadowRootInWxmlPanel": true,
        "packNpmManually": false,
        "enableEngineNative": false,
        "packNpmRelationList": [],
        "minifyWXSS": true,
        "showES6CompileOption": false,
        "minifyWXML": true
    },
    "compileType": "miniprogram",
    "libVersion": "2.19.4",
    "appid": "wxb2c7b1f97623094b",
    "projectname": "demo-%E4%BA%91%E5%BC%80%E5%8F%91",
    "debugOptions": {
        "hidedInDevtools": []
    },
    "scripts": {},
    "staticServerOptions": {
        "baseURL": "",
        "servePath": ""
    },
    "isGameTourist": false,
    "condition": {
        "search": {
            "list": []
        },
        "conversation": {
            "list": []
        },
        "game": {
            "list": []
        },
        "plugin": {
            "list": []
        },
        "gamePlugin": {
            "list": []
        },
        "miniprogram": {
            "list": []
        }
    }
}
```

### 步骤3

然后在目录新建：cloudfunctionRoot的值

```
"cloudfunctionRoot": "cloud/"
```

![image-20220307124820577](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307124820577.png)

### 步骤4

在全局目录下新建app.js文件

![image-20220307124902710](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307124902710.png)

### 步骤5

app.js

```js
// app.js
App({
  onLaunch:function () {
    //云开发初始化
    wx.cloud.init({
      env:"demo-1gbuek8k4129587e"
    })
  }
})
```

## 云开发增删改查

### 增加数据

#### 步骤1

编写wxml

```html
<view>
  <input type="text" value="{{name}}" bindinput="addInput" placeholder="请输入内容"/>
  <button bindtap="addData">添加数据</button>
</view>
```

#### 步骤2

添加事件

```js
Page({
  data:{
      name:''
  },
  addInput(e){
    this.setData({
      name:e.detail.value
    })
  },
  addData(){
    DB.add({
      data:{
        name:this.data.name,
        age:18,
      },
      success(res){
        console.log("添加成功",res);
      },
      fali(res){
        console.log("添加失败",res);
      }
    })
  },
})
```

#### 步骤3

```js
// 添加云数据库
const DB=wx.cloud.database().collection("list")
Page({
  data:{
      name:''
  },
  addInput(e){
    this.setData({
      name:e.detail.value
    })
  },
  addData(){
    DB.add({
      data:{
        name:this.data.name,
        age:18,
      },
      success(res){
        console.log("添加成功",res);
      },
      fali(res){
        console.log("添加失败",res);
      }
    })
  },
})
```

#### 完成

![image-20220307141408062](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307141408062.png)

#### 总结

创建一个对象DB（可以自己命名的）用于接收声明云数据库的集合（命名为list，需要在编程前在云函数中创建）的返回值

### 查询数据

#### 步骤1

添加wxml

```html
<view>
  <button bindtap="getData">查询数据</button>
</view>
```

#### 步骤2

```js
getData(){
    DB.get({
      success(res){
        console.log('查询数据成功',res);
      },
      fali(res){
        console.log("查询失败",res);
      }
    })
  }
```

#### 完成

![image-20220307142842846](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307142842846.png)

### 删除数据

#### 步骤1

添加wxml

```html
<view>
  <input type="text" bindinput="delId"/>
  <button bindtap="remData"></button>
</view>
```

#### 步骤2

```js
let id=''  
// 输入要删除的数据
  delId(e){
    id=e.detail.value
  },
  // 删除目标id的数据
  remData(){
    DB.doc(id).remove({
      success(res){
        console.log('删除成功',res);
      },
      fali(res){
        console.log("删除失败",res);
      }
    })
  }
```

#### 完成

![image-20220307162756986](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307162756986.png)

### 数据更新

#### 步骤1

添加wxml

```
<view>
  <input type="text" bindinput="updataId" placeholder="输入要修改的id"/>
  <input type="text" bindinput="updataName" placeholder="输入要更新的名字"/>
  <input type="text" bindinput="updataAge" placeholder="输入要更新的年龄"/>
  <button type="default" bindtap="updataData">修改数据</button>
</view>
```

#### 步骤2

```js
  // 将修改数据的id
  updataId(e){
    upId=e.detail.value
  },
  // 修改姓名
  updataName(e) {
    this.setData({
      name: e.detail.value
    })
  },
  // 修改年龄
  updataAge(e) {
    this.setData({
      age: e.detail.value
    })
  },
  // 修改更新数据
  updataData() {
    DB.doc(upId).update({
      data:{
        name: this.data.name,
        age: this.data.age,
      },
      success(res) {
        console.log('更新成功', res);
      },
    })
  }
```

#### 完成

![image-20220307175841426](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307175841426.png)

## 云函数

cloud右键选择创建node.js云函数

![image-20220307191305379](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307191305379.png)

![image-20220307191628212](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307191628212.png)

index.js

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init()

// 云函数入口函数
exports.main = async (event, context) => {
    const wxContext = cloud.getWXContext()

    return {
        event,
        openid: wxContext.OPENID,
        appid: wxContext.APPID,
        unionid: wxContext.UNIONID,
    }
}
```

### 创建第一个云函数

#### 云函数端

求两个数的和

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init()

// 云函数入口函数
exports.main = async (event, context) => {
    let a=event.a;
    let b=event.b;
    return a+b;
}
```

#### 小程序端

```html
<view>
    <text>云函数</text><br/>
    <button bindtap="addCount">点击</button>
</view>
```

```js
Page({
    // 第一个云函数
    addCount(){
        wx.cloud.callFunction({
            name:'demo',
            data:{
                a:5,
                b:3
            },
            success(res){
                console.log('请求成功',res.result);
            },
            fail(res){
                console.log("请求失败",res);
            }
        })
    }
})
```

#### 结果

![image-20220307210210778](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220307210210778.png)

### 使用云函数获取用户的openid

#### 云函数端

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init()

// 云函数入口函数
exports.main = async (event, context) => {
    const wxContext = cloud.getWXContext()

    return {
        event,
        openid: wxContext.OPENID,
        appid: wxContext.APPID,
        unionid: wxContext.UNIONID,
    }
}
```

#### 小程序端

```js
Page({
    addOpenId(){
        wx.cloud.callFunction({
            name:'getopenid',
            success(res){
                console.log("获取openid成功",res.result.event.userInfo.openId);
            },
            fail(res){
                console.log("请求失败",res);
            }
        })
    }
})
```

为什么要用云函数获取数据库的数据？ 1，运函数获取数据库数据可以突破20条的限制←

2. 还函数获取数据库不受数据表的权限控制4 3，运函数可以实现的功能更多。

为什么要用云函数获取数据库的数据？ 1，运函数获取数据库数据可以突破20条的限制←

2. 还函数获取数据库不受数据表的权限控制4

3. 运函数可以实现的功能更多。

### 获取数据

```html
<view>
<br/>
  <button bindtap="getSql">数据库api获取数据</button>
  <button bindtap="getCloudSQL  ">云函数获取数据</button>
</view>
```

#### 通过数据库api获取

```js
const sql = wx.cloud.database().collection("users");
```

```js
Page({
    getSql(){
        sql.get({
          success(res){
            console.log("获取成功",res);
          },
          fali(res){
            console.log('获取失败',res);
          }
        })
    }
})
```

#### 通过云函数获取

```js
Page({
    getCloudSQL(){
    wx.cloud.callFunction({
      name:'getData',
      success(res){
        console.log('获取数据成功',res);
      },
      fali(res){
        console.log("获取数据失败",res);
      }
    })
  }
})
```

## 云储存

### 上传文件

在小程序端可调用 `wx.cloud.uploadFile` 方法进行上传：

```js
wx.cloud.uploadFile({
  cloudPath: 'example.png', // 上传至云端的路径
  filePath: '', // 小程序临时文件路径
  success: res => {
    // 返回文件 ID
    console.log(res.fileID)
  },
  fail: console.error
})
```

### 上传图片

wx.chooseImage(Object object)

```
wx.chooseImage({
  count: 1,
  sizeType: ['original', 'compressed'],
  sourceType: ['album', 'camera'],
  success (res) {
    // tempFilePath可以作为img标签的src属性显示图片
    const tempFilePaths = res.tempFilePaths
  }
})
```

### 代码

```js
Page({
    // 随机图片
    nanImg(){
        let mainname=''+Date.now()+Math.ceil(Math.random()*10);
        return mainname
    },
    //上传文件
    UploadFile(){
        wx.chooseImage({
            count: 1,
            sizeType: ['original', 'compressed'],
            sourceType: ['album', 'camera'],
            success :(res)=> {
                console.log('选择成功',res);
                this.upImg(res.tempFilePaths[0])
            }
          })
    },
    upImg(url){
        wx.cloud.uploadFile({
            cloudPath: `${this.nanImg()}.jpg`, // 上传至云端的路径
            filePath: url, // 小程序临时文件路径
            success: res => {
              // 返回文件 ID
              console.log("上传成功",res)
            },
            fail: console.error
          })
    }
})
```

![image-20220308004535551](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220308004535551.png)

### 实时更新图片

```
<view>
    <text>展示存储的图片</text><br/>
   <image src="{{imgUrl}}"></image>
</view>
```

```js
Page({
    data:{
        imgUrl:''
    },
    // 随机图片
    nanImg(){
        let mainname=''+Date.now()+Math.ceil(Math.random()*10);
        return mainname
    },
    //上传文件
    UploadFile(){
        wx.chooseImage({
            count: 1,
            sizeType: ['original', 'compressed'],
            sourceType: ['album', 'camera'],
            success :(res)=> {
                console.log('选择成功',res);
                this.upImg(res.tempFilePaths[0])
            }
          })
    },
    upImg(url){
        wx.cloud.uploadFile({
            cloudPath: `image/${this.nanImg()}.jpg`, // 上传至云端的路径
            filePath: url, // 小程序临时文件路径
            success: res => {
              // 返回文件 ID
              console.log("上传成功",res.fileID)
              this.setData({
                imgUrl:res.fileID
              })
            },
            fail: console.error
          })
    }
})
```

![image-20220308005530233](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220308005530233.png)

### 上传excel文件

添加html

```html
    <view>
        <text style="text-align: center;">上传excel文件</text>
        <button bindtap="upexcel">上传excel文件</button>
    </view>
```

```javascript
// pages/upload/upload.js
let util=require("../../utils/util")
Page({
    upexcel(){
        wx.chooseMessageFile({
            count:1,
            type: 'all',
            success :(res)=> {
              // tempFilePath可以作为img标签的src属性显示图片
            console.log("上传成功",res);
              this.uploadExcel(res)
            }
          })
    },
    uploadExcel(url){
        wx.cloud.uploadFile({
            cloudPath: `excel/${util.randomImg()}.xlsx`, // 上传至云端的路径
            filePath: url.tempFiles[0].path, // 小程序临时文件路径
            success: res => {
              // 返回文件 ID
              console.log("上传成功",res)
            },
            fail: res=>{
                console.log(res);
            }
          })
    }
})
```

### 下载并打开excel

```html
<view>
    <text style="text-align: center;">下载并打开excel文件</text>
    <button bindtap="downloadexcel">下载excel文件</button>
</view>
```

```javascript
Page({
	  downloadexcel() {
    wx.cloud.downloadFile({
      fileID: this.data.excel, // 文件 ID
      success: res => {
        // 返回临时文件路径
        this.openFlie(res.tempFilePath)
      },
      fail: console.error
    })
  },
  openFlie(url) {
    wx.openDocument({
      filePath: url,
      success: function (res) {
        console.log('打开文档成功', res)
      }
    })
  }
})
```

### 添加21条数据请求数据库

- #### 数据文件

```json
{"_id":"bf4a0bf262272bfd13621d9c2a04cc78","address":"广东汕头","age":18.0,"name":"测试用户9"}
{"_id":"bf4a0bf262272c1813622047357f81c9","address":"广东东莞","age":16.0,"name":"测试用户11"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc10","address":"广东汕头","age":18.0,"name":"测试用户12"}
{"_id":"bf4a0bf262272c1813622047357f8111","address":"广东东莞1","age":16.0,"name":"测试用户19"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc12","address":"广东汕头2","age":18.0,"name":"测试用户13"}
{"_id":"bf4a0bf262272c1813622047357f8113","address":"广东东莞3","age":16.0,"name":"测试用户14"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc14","address":"广东汕头4","age":18.0,"name":"测试用户15"}
{"_id":"bf4a0bf262272c1813622047357f8115","address":"广东东莞5","age":16.0,"name":"测试用户16"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc16","address":"广东汕头6","age":18.0,"name":"测试用户17"}
{"_id":"bf4a0bf262272c1813622047357f8117","address":"广东东莞7","age":16.0,"name":"测试用户18"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc18","address":"广东汕头","age":18.0,"name":"测试用户20"}
{"_id":"bf4a0bf262272c1813622047357f8119","address":"广东东莞","age":16.0,"name":"测试用户21"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc20","address":"广东汕头","age":18.0,"name":"测试用户22"}
{"_id":"bf4a0bf262272c1813622047357f8121","address":"广东东莞1","age":16.0,"name":"测试用户23"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc22","address":"广东汕头2","age":18.0,"name":"测试用户24"}
{"_id":"bf4a0bf262272c1813622047357f8123","address":"广东东莞3","age":16.0,"name":"测试用户25"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc24","address":"广东汕头4","age":18.0,"name":"测试用户29"}
{"_id":"bf4a0bf262272c1813622047357f8125","address":"广东东莞5","age":16.0,"name":"测试用户26"}
{"_id":"bf4a0bf262272bfd13621d9c2a04cc26","address":"广东汕头6","age":18.0,"name":"测试用户27"}
{"_id":"bf4a0bf262272c1813622047357f8127","address":"广东东莞7","age":16.0,"name":"测试用户28"}
```

- #### wxml

  ```html
  <view>
      <button bindtap="address">获取云数据</button>
  </view>
  <view class="view1" wx:for="{{list}}" wx:key="id">
      <view>我是{{item.name}}</view>
      <view>我今年{{item.age}}岁</view>
      <view>来自{{item.address}}</view>
      <hr/>
  </view>
  ```

- ### js

  ```js
  // index.js
  // 获取应用实例
      let db=wx.cloud.database().collection("user")      
  Page({
      data:{
        list:[]
      },
      address(res){
        db.get({
          success:(res)=>{
            this.setData({
              list:res.data
            })
          },
          fail:(res)=>{
            console.log(res);
          }
        })
      }
  })
  ```

云数据库一次最多请求20条数据,云函数一次最多请求100 条数据

### 使用云函数突破20条数据的限制

#### 新建云函数文件

![image-20220309102551235](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220309102551235.png)

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')

cloud.init({
  env:'weixin-1gphk0fkc423f2ca'
})

// 云函数入口函数
let db= cloud.database().collection("user");
exports.main = async (event, context) => {
      return db.get({
      success:(res)=>{
        return res
      },
      fail:(res)=>{
        return res
      }
    })
}
```

#### 在pages里面新建一个文件

![image-20220309102637835](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220309102637835.png)

- yun.wxml

  ```
  <view>
      <button bindtap="addData">获取云数据</button>
  </view>
  <view class="view1" wx:for="{{list}}" wx:key="id">
      <view>我是{{item.name}}</view>
      <view>我今年{{item.age}}岁</view>
      <view>来自{{item.address}}</view>
      <hr/>
  </view>
  ```

- yun.js

  ```js
  // index.js
  // 获取应用实例
  
  Page({
      data:{
        list:[]
      },
      addData(res){
        wx.cloud.callFunction({
          name:'demo',
          success:(res)=>{
            this.setData({
              list:res.result.data
            })
          },
          fail:(res)=>{
            console.log("请求云函数失败",res);
          }
        })
      }
  })
  
  ```

  ![image-20220309102751690](C:\Users\move\AppData\Roaming\Typora\typora-user-images\image-20220309102751690.png)

## 分页请求数据

### wxml

```
<view>
  <view wx:for="{{list}}" wx:key="_id" class="index">
    <text>{{item.num}}</text>
  </view>
</view>
```

wxjs

```js
// pages/list/list.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
    list: [],
    index: 0
  },
  getData(num) {
    wx.cloud.database().collection("SetList").skip(num).get()
      .then(res => {
        this.setData({
          list: this.data.list.concat(res.data)
        })

      })
      .catch(res => {
        console.log(res);
      })
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.getData(this.data.index);
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    this.setData({
      index: this.data.index += 20
    })
    this.getData(this.data.index);
    console.log(this.data.index);
  },

})
```

### 改进版

```js
// pages/list/list.js
let pageS= -1
Page({

  /**
   * 页面的初始数据
   */
  data: {
    list: [],
    index: 0
  },
  getData(num) {
    // 判断数据是否全部加载完毕
    let len=this.data.list.length
    if(pageS==len){
      wx.showToast({
        title: '数据已经加载完毕',
      })

      return
    }
    // 加载提示插件
    wx.showLoading({
      title: '加载中',
    })
    //链接数据库
    wx.cloud.database().collection("SetList").skip(num).get()
      .then(res => {
        this.setData({
          list: this.data.list.concat(res.data)
        })
        // 加载完毕
        wx.hideLoading()
        wx.showToast({
          title: '加载成功',
        })
      })
      .catch(res => {
        console.log(res);
        wx.shouToast({
          title:'加载失败'
        })
      })
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    wx.cloud.database().collection('SetList').count().then(res=>{
        pageS=res.total
    })
    this.getData(this.data.index);
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    this.setData({
      index: this.data.index += 20
    })
    this.getData(this.data.index);
  },

})
```

## 收藏功能

wxml

```html
<view>
  <image src="{{imgUrl}}" bindtap="Collection"></image>
</view>
```

wxjs

```js
let whether=false
Page({
  data:{
    imgUrl:'../../iocn/_收藏2 (1).png'
  },
  Collection(){
    this.setData({
      imgUrl:whether?'../../iocn/_收藏2 (1).png':'../../iocn/_收藏2.png'
    })
    whether=!whether
  }
})
```

## 点赞功能

wxml

```html
<view>
  <image src="{{imageUrl}}" bindtap="give"></image>
</view>
```

wxjs

```
let wetch=false
Page({
  data:{
    imageUrl:'../../iocn/点赞.png'
  },
  give(){
    this.setData({
      imageUrl:whether?'../../iocn/点赞.png':'../../iocn/点赞 (1).png'
    })
  }
})
```

## 列表跳转到详情页并携带id数据

### json数据

```json
{"_id":"41ae62ef6228a45d0b530c084550eb321","desc":"描述1","title":"标题1"}
{"_id":"17e3426e6228a49912a4536b30d9e43c2","desc":"描述2","title":"标题2"}
{"_id":"41ae62ef6228a45d0b530c084550eb323","desc":"描述3","title":"标题3"}
{"_id":"17e3426e6228a49912a4536b30d9e43c4","desc":"描述4","title":"标题4"}
{"_id":"41ae62ef6228a45d0b530c084550eb325","desc":"描述5","title":"标题5"}
{"_id":"17e3426e6228a49912a4536b30d9e43c6","desc":"描述6","title":"标题6"}
{"_id":"41ae62ef6228a45d0b530c084550eb327","desc":"描述7","title":"标题7"}
{"_id":"41ae62ef6228a45d0b530c084550eb329","desc":"描述9","title":"标题8"}
{"_id":"17e3426e6228a49912a4536b30d9e43c8","desc":"描述8","title":"标题9"}
{"_id":"17e3426e6228a49912a4536b30d9e43c10","desc":"描述10","title":"标题10"}
```

### 列表页-seter

#### wxml

```html
<block wx:for="{{list}}" wx:key="id">
  <view bindtap="cs" data-id="{{item._id}}">
    <text>{{item.title}}</text>
    <text>{{item.desc}}</text>
  </view>
</block>
<view>
  <button bindtap="btn">点击</button>
</view>
```

wxjs

```js
const DB=wx.cloud.database().collection("todos")
Page({
  data:{
    list:[]
  },
    // 获取数据库数据
  onLoad(){
      DB.get().then(res=>{
        console.log(res);
        this.setData({
          list:res.data
        })
      })
  },
    // 向点击的标签发送数据
  cs(e){
    let id=e.currentTarget.dataset.id
    wx.navigateTo({
      url: `/pages/details/details?id=${id}`,
    })
  }
})
```

### 详情页-details

#### wxml

```html
<block>
  <view>
    {{title}}
  </view>
    {{desc}}
  <view>
  </view>
</block>
```

wx.js

```js
// pages/details/details.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
    title:'',
    desc:''
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    console.log("详情页请求的id",options);
    wx.cloud.database().collection("todos").doc(options.id).get()
    .then(res=>{
      this.setData({
        title:res.data.title,
        desc:res.data.desc
      })
    })
  },
})
```

